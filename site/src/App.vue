<template>
    <!-- TODO: Solve mysterious min-width ??? -->
    <FormLogin :show-login="showLogin" @toggle-login="toggleLogin" />

    <div class="flex flex-row w-screen h-screen z-1" :class="{ 'brightness-50': showModal }">
        <SideBar
            ref="sidebar"
            :collapsed="closedSidebar && !uncollapsedSidebar"
            :uncollapsed="uncollapsedSidebar"
            :collapsing="collapsingSidebar"
            @close-side-bar="toggleSidebar"
        />
        <div
            ref="content"
            :class="{ 'brightness-50': uncollapsedSidebar && !collapsingSidebar }"
            class="flex overflow-auto relative flex-col w-full bg-2 h-content after-topbar app-scrollbar"
        >
            <div class="flex-auto shrink-0 grow-1">
                <router-view />
            </div>
            <FooterBar class="shrink-0" />
        </div>
        <TopBar
            ref="topbar"
            class="flex fixed top-0 left-0 justify-between items-center w-full border-b h-tbar border-bar text-1 bg-1"
            :show-login="showLogin"
            :class="{ 'brightness-50': uncollapsedSidebar && !collapsingSidebar }"
            @toggle-login="toggleLogin"
            @toggle-side-bar="toggleSidebar"
        />
    </div>
</template>

<script lang="js">
    import FooterBar from '@/components/Bar/FooterBar.vue'
    import SideBar from '@/components/Bar/SideBar.vue'
    import TopBar from '@/components/Bar/TopBar.vue'
    import FormLogin from '@/components/Form/FormLogin.vue'
    import User from '@/models/user'
    import debounce from 'lodash/debounce'
    import { ref, watch } from 'vue'

    const breakWidth = 768
    export default {
        components: {
            TopBar,
            SideBar,
            FooterBar,
            FormLogin,
        },
        setup () {
            const showLogin = ref(false)
            const showModal = ref(false)

            const sidebar = ref(null)
            const topbar = ref(null)
            const content = ref(null)
            return {
                sidebar,
                topbar,
                content,
                showLogin,
                showModal,
                toggleModal () {
                    showModal.value = !showModal.value
                    showLogin.value = showModal.value
                },
                toggleLogin () {
                    showLogin.value = !showLogin.value
                    showModal.value = showLogin.value
                },
            }
        },
        data () {
            const isScreenSmall = () => Math.max(
                document.documentElement.clientWidth ||
            0, window.innerWidth || 0) <= breakWidth

            const checkResize = debounce(() => {
                if (!this.isScreenSmall() && this.smallScreen) {
                    this.smallScreen = false

                    if (this.uncollapsedSidebar) {
                        this.uncollapsedSidebar = false
                        this.topbar.$el.removeEventListener('mousedown', this.toggleSidebar)
                        this.content.removeEventListener('mousedown', this.toggleSidebar)
                    }
                    if (this.closedSidebar) {
                        this.closedSidebar = false
                    }
                } else if (this.isScreenSmall() && !this.smallScreen) {
                    this.smallScreen = true
                    if (!this.closedSidebar) {
                        this.closedSidebar = true
                    }
                }
            }, 50)

            return {
                checkResize,
                user: new User('', '', ''),
                isScreenSmall,
                closedSidebar: isScreenSmall(),
                smallScreen: isScreenSmall(),
                uncollapsedSidebar: false,
                collapsingSidebar: false,
            }
        },
        created () {
            document.querySelector(':root').className = this.$store.state.user.theme
            const cookie = this.$cookies.get('accessTokenExpiresAt')
            if (cookie) {
                if (cookie > Date.now()) {
                    this.$store.dispatch('auth/me')
                } else {
                    this.$store.dispatch('logout')
                }
            }
        },
        mounted () {
            watch(() => this.$store.getters['user/getTheme'], (theme) => {
                document.querySelector(':root').className = theme
            })

            this.$emitter.on('login', () => {
                this.toggleLogin()
            })

            this.$emitter.on('toggle-modal', () => {
                this.toggleModal()
            })

            window.addEventListener('resize', this.checkResize)
        },
        unmounted () {
            window.removeEventListener('resize', this.checkResize)
        },
        methods: {
            login() {
                this.toggleLogin()
            },
            toggleSidebar () {
                if (this.smallScreen) {
                    if (this.uncollapsedSidebar) {
                        this.topbar.$el.removeEventListener('mousedown', this.toggleSidebar)
                        this.content.removeEventListener('mousedown', this.toggleSidebar)
                        this.collapsingSidebar = true
                        this.sidebar.$el.addEventListener('transitionend', () => {
                            this.uncollapsedSidebar = false
                            this.collapsingSidebar = false
                        }, { once: true })
                    } else {
                        this.uncollapsedSidebar = true
                        this.topbar.$el.addEventListener('mousedown', this.toggleSidebar)
                        this.content.addEventListener('mousedown', this.toggleSidebar)
                    }
                } else {
                    this.closedSidebar = !this.closedSidebar
                }
            },
        },
    }
</script>

<style lang="scss">
    @import '@/assets/scss/app';
    @import '@/assets/scss/components/button';
    @import '@/assets/scss/components/card';
    @import '@/assets/scss/components/input';
    @import '@/assets/scss/components/link';
    @import '@/assets/scss/components/select';
    @import '@/assets/scss/components/tiptap';
    @import '@/assets/scss/sections/hero';
    @import '@/assets/scss/sections/label';
    @import '@/assets/scss/sections/transition';
    @import '@/assets/scss/core/scrollbar';
    @import '@/assets/scss/core/spacing';
    @import '@/assets/scss/core/tab';

    @font-face {
        font-family: AtkinsonHyperlegible;
        font-weight: 400;
        src: url('@/assets/font/AtkinsonHyperlegible/AtkinsonHyperlegible-Regular.ttf') format('truetype');
    }

    @font-face {
        font-family: AtkinsonHyperlegible;
        font-style: italic;
        font-weight: 400;
        src: url('@/assets/font/AtkinsonHyperlegible/AtkinsonHyperlegible-Italic.ttf') format('truetype');
    }

    @font-face {
        font-family: AtkinsonHyperlegible;
        font-weight: 700;
        src: url('@/assets/font/AtkinsonHyperlegible/AtkinsonHyperlegible-Bold.ttf') format('truetype');
    }

    @font-face {
        font-family: AtkinsonHyperlegible;
        font-style: italic;
        font-weight: 700;
        src: url('@/assets/font/AtkinsonHyperlegible/AtkinsonHyperlegible-BoldItalic.ttf') format('truetype');
    }

    * {
        font-family: AtkinsonHyperlegible, sans-serif;
    }

    // TODO: Adapt font size to screen size (for small screen sizes)
    html {
        font-size: 12px;
    }

    @media (min-width: 768px) {
        html {
            font-size: 15px;
        }
    }
</style>
